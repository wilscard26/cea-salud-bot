<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEA Salud – Asistente de Citas</title>
  <style>
    :root{
      --bg:#0b132b;        /* azul oscuro */
      --bg-soft:#1c2541;   /* azul medio */
      --accent:#3a86ff;    /* acento */
      --ok:#38b000;        /* ok */
      --danger:#d00000;    /* error */
      --text:#e9f1ff;      /* texto claro */
      --muted:#9fb3d6;     /* texto tenue */
      --card:#111827;      /* tarjeta */
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0f233d 60%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:center;padding:20px 12px;background:transparent}
    header img{height:44px;width:44px;border-radius:12px;background:#fff;object-fit:cover}
    header .titles{display:flex;flex-direction:column;line-height:1}
    header .titles h1{margin:0;font-size:20px}
    header .titles span{font-size:12px;color:var(--muted)}

    .app{max-width:920px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}

    .panel{background:rgba(17,24,39,.6);backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .panel .bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--bg-soft)}
    .panel .bar .status{font-size:12px;color:var(--muted)}

    #chat{height:62vh;min-height:420px;overflow:auto;padding:18px;scroll-behavior:smooth}
    #chat ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}

    .msg{max-width:85%;padding:12px 14px;border-radius:14px;font-size:15px;line-height:1.35;background:#0f1b33;border:1px solid rgba(255,255,255,.06)}
    .bot{align-self:flex-start;background:#0e223f}
    .bot .meta{color:var(--muted);font-size:12px;margin-top:6px}
    .user{align-self:flex-end;background:#12254a}

    .quickbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px 14px;border-top:1px solid rgba(255,255,255,.08);background:rgba(10,17,34,.6)}
    .chip{border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px;background:transparent;color:#fff}
    .chip:hover{border-color:var(--accent)}

    .composer{display:flex;gap:10px;padding:10px;background:rgba(10,17,34,.8);border-top:1px solid rgba(255,255,255,.08)}
    .composer input{flex:1;border:1px solid rgba(255,255,255,.12);background:#0e1a31;color:#fff;border-radius:10px;padding:12px 14px;font-size:15px}
    .composer button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-size:15px;cursor:pointer}
    .composer button:disabled{opacity:.5;cursor:not-allowed}

    .tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-size:12px;color:var(--muted)}

    footer{max-width:920px;margin:6px auto 18px;color:var(--muted);font-size:12px;text-align:center}
    a{color:#9ec1ff}

    @media (min-width:900px){
      .grid{grid-template-columns:380px 1fr}
      #chat{height:68vh}
    }
  </style>
</head>
<body>
  <header>
    <img id="logo" src="https://dummyimage.com/200x200/ffffff/000.png&text=CEA" alt="CEA Salud"/>
    <div class="titles">
      <h1>CEA Salud – Asistente virtual</h1>
      <span>Citas de medicina general • demo académico</span>
    </div>
  </header>

  <div class="app grid">
    <!-- Panel lateral con info fija -->
    <aside class="panel" aria-label="Información del centro">
      <div class="bar"><strong>CEA Salud</strong><span class="status">Centro médico • demo</span></div>
      <div style="padding:14px 16px;font-size:14px;color:#d7e2ff">
        <p><strong>Dirección</strong><br/>Av. El Dorado No. 03-23</p>
        <p><strong>Teléfono</strong><br/><a href="tel:+573232378913">+57 323 237 8913</a></p>
        <p><strong>Horario hoy</strong><br/>09:00 • 11:00 • 14:00 • 16:00</p>
        <p><strong>Cómo funciona</strong><br/>Chatea, elige una opción y confirma horario. Tus datos se guardan en este navegador.</p>
        <p class="tag">Datos locales (localStorage)</p>
      </div>
    </aside>

    <!-- Panel de chat -->
    <section class="panel" aria-label="Chat">
      <div class="bar">
        <div>Asistente</div>
        <div class="status" id="status">en línea</div>
      </div>
      <div id="chat"><ul id="log"></ul></div>

      <div class="quickbar" id="quickbar"></div>

      <div class="composer">
        <input id="input" placeholder="Escribe aquí…" autocomplete="off" />
        <button id="send">Enviar</button>
      </div>
    </section>
  </div>

  <footer>
    Proyecto académico. Sin conexión a bases de datos reales. Puedes publicar este archivo como sitio estático (GitHub Pages o Netlify).
  </footer>

  <script>
    // === Datos de negocio de la demo ===
    const BUSINESS = {
      name: 'CEA Salud',
      address: 'Av. El Dorado No. 03-23',
      phone: '+57 323 237 8913',
      times: ['09:00', '11:00', '14:00', '16:00'], // horarios del día
      expertContact: 'tel:+573232378913' // o usa whatsapp: 'https://wa.me/573232378913'
    };

    // === Estado y almacenamiento ===
    const DBKEY = 'ceaApp_appointments_v1';
    const state = { step: 'idle', temp: {}, lastMenu: 'root' };

    function loadAppointments(){
      try{ return JSON.parse(localStorage.getItem(DBKEY)) || []; }catch(e){ return []; }
    }
    function saveAppointments(list){ localStorage.setItem(DBKEY, JSON.stringify(list)); }
    function listToday(){
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      return {iso:`${y}-${m}-${d}`, label: today.toLocaleDateString('es-CO',{weekday:'long', day:'2-digit', month:'long'})};
    }

    // === UI helpers ===
    const logEl = document.getElementById('log');
    const inputEl = document.getElementById('input');
    const quickbar = document.getElementById('quickbar');
    const sendBtn = document.getElementById('send');
    const chatEl = document.getElementById('chat');

    function addMsg(html, who='bot'){
      const li = document.createElement('li');
      li.className = `msg ${who}`;
      li.innerHTML = html;
      logEl.appendChild(li);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function bot(text){ addMsg(escapeHtml(text),'bot'); }
    function botHTML(html){ addMsg(html,'bot'); }
    function user(text){ addMsg(escapeHtml(text),'user'); }
    function escapeHtml(str){ return str?.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) || ''; }

    function chips(options){
      quickbar.innerHTML = '';
      (options||[]).forEach(opt => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = opt.label;
        b.dataset.action = opt.action || '';
        b.addEventListener('click', () => handleAction(opt.action));
        quickbar.appendChild(b);
      });
    }

    function mainMenu(){
      state.step = 'idle';
      state.lastMenu = 'root';
      chips([
        {label:'Consultar disponibilidad', action:'show_schedule'},
        {label:'Agendar cita médica', action:'book_start'},
        {label:'Confirmar cita', action:'confirm_lookup'},
        {label:'Hablar con un experto', action:'expert_start'}
      ]);
      bot('Elige una opción. También puedes escribir.');
    }

    // === Flujo: agendar ===
    function startBooking(){
      state.step = 'ask_name';
      state.temp = {};
      chips([]);
      bot('Perfecto. Para agendar necesito algunos datos. ¿Cuál es tu nombre completo?');
    }

    function onUserInput(text){
      const t = text.trim(); if(!t) return;
      user(t);
      switch(state.step){
        case 'ask_name':
          state.temp.name = t; state.step = 'ask_id';
          bot('Documento de identidad:'); break;
        case 'ask_id':
          state.temp.id = t; state.step = 'ask_email';
          bot('Correo electrónico:'); break;
        case 'ask_email':
          if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t)){ bot('Correo no válido. Intenta de nuevo:'); return; }
          state.temp.email = t; state.step = 'pick_time';
          showAvailableTimes('Elige un horario para hoy:'); break;
        case 'pick_time':
          selectTime(t); break;
        case 'lookup_key':
          lookupAppointment(t); break;
        case 'expert_name':
          state.temp.name = t; state.step = 'expert_id'; bot('Documento de identidad:'); break;
        case 'expert_id':
          state.temp.id = t; state.step = 'expert_email'; bot('Correo electrónico:'); break;
        case 'expert_email':
          if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(t)){ bot('Correo no válido. Intenta de nuevo:'); return; }
          state.step = 'idle';
          botHTML(`Listo. Puedes contactar a un experto aquí: <a href="${BUSINESS.expertContact}" target="_blank" rel="noopener">Abrir contacto</a>.`);
          chips([{label:'Volver al menú', action:'menu'}]);
          break;
        default:
          // intenta mapear al menú por texto libre
          routeByFreeText(t);
      }
    }

    function routeByFreeText(t){
      const s = t.toLowerCase();
      if(s.includes('agendar')) return handleAction('book_start');
      if(s.includes('dispon')||s.includes('horario')) return handleAction('show_schedule');
      if(s.includes('confirm')) return handleAction('confirm_lookup');
      if(s.includes('experto')||s.includes('hablar')) return handleAction('expert_start');
      bot('No entendí. Usa el menú.');
    }

    function showAvailableTimes(prefix='Horarios disponibles hoy:'){
      const {iso, label} = listToday();
      const booked = loadAppointments().filter(a => a.date === iso).map(a => a.time);
      const avail = BUSINESS.times.filter(t => !booked.includes(t));
      if(avail.length===0){ bot(`No hay cupos para hoy (${label}).`); chips([{label:'Volver al menú', action:'menu'}]); return; }
      bot(`${prefix}`);
      chips(avail.map(time => ({label: time, action: `pick_${time}`})).concat([{label:'Cancelar', action:'menu'}]));
      state.step = 'pick_time';
    }

    function selectTime(raw){
      const time = raw.replace(/^pick_/,'');
      if(!BUSINESS.times.includes(time)) { bot('Selecciona un horario del menú.'); return; }
      const {iso, label} = listToday();
      // guarda
      const appts = loadAppointments();
      appts.push({
        id: state.temp.id,
        email: state.temp.email,
        name: state.temp.name,
        date: iso,
        time
      });
      saveAppointments(appts);
      chips([{label:'Volver al menú', action:'menu'}, {label:'Ver disponibilidad', action:'show_schedule'}]);
      botHTML(`Tu cita médica general ha quedado <strong>confirmada</strong> para <strong>${label}</strong> a las <strong>${time}</strong> en ${BUSINESS.name}.<br><br>
      📍 <strong>Dirección:</strong> ${BUSINESS.address}<br>
      📞 <strong>Teléfono:</strong> ${BUSINESS.phone}<br>
      ✉️ Recibirás un recordatorio en este navegador.`);
      state.step='idle';
    }

    function lookupAppointment(key){
      const K = key.trim().toLowerCase();
      const appts = loadAppointments();
      const found = appts.find(a => a.id.toLowerCase()===K || a.email.toLowerCase()===K);
      if(!found){ bot('No encontré una cita con ese dato. Intenta de nuevo o vuelve al menú.'); return; }
      const date = new Date(found.date + 'T00:00:00');
      botHTML(`Cita encontrada para <strong>${found.name}</strong>: <br/>${date.toLocaleDateString('es-CO',{weekday:'long', day:'2-digit', month:'long'})} a las ${found.time}.`);
      chips([{label:'Volver al menú', action:'menu'}]);
      state.step='idle';
    }

    // === Acciones por botones ===
    function handleAction(action){
      switch(action){
        case 'menu':
          bot('Volvemos al menú.');
          mainMenu();
          return;
        case 'show_schedule':
          showAvailableTimes();
          return;
        case 'book_start':
          startBooking();
          return;
        case 'confirm_lookup':
          state.step = 'lookup_key';
          state.temp = {}; chips([]);
          bot('Para confirmar tu cita, escribe tu número de documento o tu correo:');
          return;
        case 'expert_start':
          state.step = 'expert_name'; state.temp = {}; chips([]);
          bot('Claro. Para conectarte con un experto, primero dime tu nombre completo:');
          return;
        default:
          // Horarios (pick_HH:mm)
          if(action && action.startsWith('pick_')){ selectTime(action); return; }
      }
    }

    // === inicialización ===
    function hello(){
      const {label} = listToday();
      botHTML(`<strong>¡Hola!</strong> Bienvenido a ${BUSINESS.name}. Te ayudo con tu cita de <em>medicina general</em> para hoy (<strong>${label}</strong>).`);
      mainMenu();
    }

    // eventos
    sendBtn.addEventListener('click', () => { const v = inputEl.value; inputEl.value=''; onUserInput(v); });
    inputEl.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });

    // listo
    hello();
  </script>
</body>
</html>
