<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEA Salud – Asistente de Citas</title>
  <style>
    :root{
      --bg:#0b132b; --bg-soft:#1c2541; --accent:#3a86ff;
      --ok:#38b000; --danger:#d00000; --text:#e9f1ff;
      --muted:#9fb3d6; --card:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0f233d 60%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:center;padding:20px 12px}
    header .logo{font-size:36px}
    header .titles h1{margin:0;font-size:20px}
    header .titles span{font-size:12px;color:var(--muted)}

    .app{max-width:920px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .panel{background:rgba(17,24,39,.6);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .panel .bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--bg-soft)}
    #chat{height:62vh;overflow:auto;padding:18px;scroll-behavior:smooth}
    #chat ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:85%;padding:12px 14px;border-radius:14px;font-size:15px;background:#0f1b33}
    .bot{align-self:flex-start;background:#0e223f}
    .user{align-self:flex-end;background:#12254a}
    .quickbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px 14px;border-top:1px solid rgba(255,255,255,.08)}
    .chip{border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px;color:#fff;background:transparent}
    .chip:hover{border-color:var(--accent)}
    .composer{display:flex;gap:10px;padding:10px;background:rgba(10,17,34,.8);border-top:1px solid rgba(255,255,255,.08)}
    .composer input{flex:1;border:1px solid rgba(255,255,255,.12);background:#0e1a31;color:#fff;border-radius:10px;padding:12px 14px;font-size:15px}
    .composer button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-size:15px;cursor:pointer}
    .flash{animation:flash 0.6s ease-out}@keyframes flash{0%{background:#38b000}100%{background:transparent}}
    @media (min-width:900px){.grid{grid-template-columns:380px 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo"> </div>
    <div class="titles"><h1>CEA Salud – Asistente virtual</h1><span>Citas de medicina general</span></div>
    <div id="clock" style="margin-left:20px;font-size:14px;color:var(--muted)"></div>
  </header>

  <div class="app grid">
    <aside class="panel">
      <img src="https://raw.githubusercontent.com/wilscard26/cea-salud-bot/main/logo-cea.jpeg" alt="CEA Salud" style="width:90%;max-width:220px;display:block;margin:16px auto;border-radius:8px;">
      <div class="bar"><strong>CEA Salud</strong><span>Centro médico</span></div>
      <div style="padding:14px 16px;font-size:14px">
        <p><strong>Dirección</strong><br/>Av. El Dorado No. 03-23</p>
        <p><strong>Teléfono</strong><br/><a href="tel:+573232378913">+57 323 237 8913</a></p>
        <p><strong>Horario hoy</strong><br/>09:00 • 10:00 • 11:00 • 12:00 • 13:00 • 14:00 • 15:00 • 16:00</p>
      </div>
    </aside>

    <section class="panel">
      <div class="bar"><div>Asistente</div><div class="status" id="status">en línea</div></div>
      <div id="chat"><ul id="log"></ul></div>
      <div class="quickbar" id="quickbar"></div>
      <div class="composer">
        <input id="input" placeholder="Escribe aquí…" autocomplete="off" />
        <button id="send">Enviar</button>
      </div>
    </section>
  </div>

  <script>
    const BUSINESS={name:'CEA Salud',address:'Av. El Dorado No. 03-23',phone:'+57 323 237 8913',times:['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'],expertContact:'tel:+573232378913'};
    const DBKEY='ceaApp_appointments_v1';
    const state={step:'idle',temp:{},lastMenu:'root'};

    function loadAppointments(){try{return JSON.parse(localStorage.getItem(DBKEY))||[]}catch(e){return[]}}
    function saveAppointments(list){localStorage.setItem(DBKEY,JSON.stringify(list))}
    function listDate(offset=0){const t=new Date();t.setDate(t.getDate()+offset);const y=t.getFullYear();const m=String(t.getMonth()+1).padStart(2,'0');const d=String(t.getDate()).padStart(2,'0');return{iso:`${y}-${m}-${d}`,label:t.toLocaleDateString('es-CO',{weekday:'long',day:'2-digit',month:'long'})}}

    const logEl=document.getElementById('log'),inputEl=document.getElementById('input'),quickbar=document.getElementById('quickbar'),sendBtn=document.getElementById('send'),chatEl=document.getElementById('chat');

    function addMsg(h,who='bot'){const li=document.createElement('li');li.className=`msg ${who}`;li.innerHTML=h;logEl.appendChild(li);chatEl.scrollTop=chatEl.scrollHeight}
    function bot(t){addMsg(escapeHtml(t),'bot')}function botHTML(h){addMsg(h,'bot')}function user(t){addMsg(escapeHtml(t),'user')}function escapeHtml(s){return s?.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))||''}
    function chips(o){quickbar.innerHTML='';(o||[]).forEach(opt=>{const b=document.createElement('button');b.className='chip';b.textContent=opt.label;b.addEventListener('click',()=>handleAction(opt.action));quickbar.appendChild(b)})}

    function mainMenu(){state.step='idle';chips([{label:'Consultar disponibilidad',action:'show_schedule'},{label:'Agendar cita médica',action:'book_start'},{label:'Confirmar cita',action:'confirm_lookup'},{label:'Cancelar cita',action:'cancel_lookup'},{label:'Hablar con un experto',action:'expert_start'}]);bot('Elige una opción.')}

    function startBooking(offset=0){state.step='ask_name';state.temp={offset};chips([]);bot('¿Cuál es tu nombre completo?')}

    function onUserInput(t){const v=t.trim();if(!v)return;user(v);switch(state.step){case'ask_name':state.temp.name=v;state.step='ask_id';bot('Documento de identidad (máx 10 dígitos):');break;case'ask_id':if(!/^\d{5,10}$/.test(v)){bot('Documento inválido, ingresa 5-10 dígitos numéricos.');return}state.temp.id=v;state.step='ask_email';bot('Correo electrónico:');break;case'ask_email':if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)){bot('Correo no válido.');return}state.temp.email=v;state.step='pick_time';showAvailableTimes('Elige un horario para hoy:',state.temp.offset);break;case'pick_time':selectTime(v);break;case'lookup_key':lookupAppointment(v);break;case'cancel_key':cancelAppointment(v);break;default:routeByFreeText(v)}}

    function routeByFreeText(t){const s=t.toLowerCase();if(s.includes('agendar'))return handleAction('book_start');if(s.includes('dispon'))return handleAction('show_schedule');if(s.includes('cancel'))return handleAction('cancel_lookup');bot('No entendí.')}

    function showAvailableTimes(p,offset=0){const{iso,label}=listDate(offset);const booked=loadAppointments().filter(a=>a.date===iso).map(a=>a.time);const now=new Date();const ch=now.getHours(),cm=now.getMinutes();const avail=BUSINESS.times.filter(t=>{const[h,m]=t.split(':').map(Number);return offset>0||(h>ch||(h===ch&&m>cm))}).filter(t=>!booked.includes(t));if(avail.length===0){botHTML(`⏳ No quedan horarios disponibles para ${offset===0?'hoy':'esa fecha'} (${label}).`);chips([{label:'Agendar mañana',action:'book_tomorrow'},{label:'Volver al menú',action:'menu'}]);return}bot(`${p} (${label})`);chips(avail.map(time=>({label:time,action:`pick_${time}`})).concat([{label:'Cancelar',action:'menu'}]));state.step='pick_time'}

    function selectTime(raw){const time=raw.replace(/^pick_/,'');const{iso,label}=listDate(state.temp.offset||0);const appts=loadAppointments();appts.push({id:state.temp.id,email:state.temp.email,name:state.temp.name,date:iso,time});saveAppointments(appts);botHTML(`<div class="flash">✔️ Cita confirmada para <strong>${label}</strong> a las <strong>${time}</strong>.</div>`);chips([{label:'Volver al menú',action:'menu'}]);state.step='idle'}

    function lookupAppointment(key){const appts=loadAppointments();const found=appts.find(a=>a.id===key||a.email.toLowerCase()===key.toLowerCase());if(!found){bot('No encontré cita.');return}botHTML(`Cita de ${found.name}: ${found.date} ${found.time}`);chips([{label:'Volver al menú',action:'menu'}])}

    function cancelAppointment(key){let appts=loadAppointments();const before=appts.length;appts=appts.filter(a=>a.id!==key&&a.email.toLowerCase()!==key.toLowerCase());if(appts.length===before){bot('No encontré cita para cancelar.');return}saveAppointments(appts);bot('✅ Cita cancelada.');chips([{label:'Volver al menú',action:'menu'}])}

    function handleAction(a){switch(a){case'menu':mainMenu();return;case'show_schedule':showAvailableTimes('Horarios disponibles');return;case'book_start':startBooking(0);return;case'book_tomorrow':startBooking(1);return;case'confirm_lookup':state.step='lookup_key';chips([]);bot('Documento o correo para buscar cita:');return;case'cancel_lookup':state.step='cancel_key';chips([]);bot('Documento o correo para cancelar cita:');return}}

    function hello(){const{label}=listDate();botHTML(`<strong>¡Hola!</strong> Bienvenido a ${BUSINESS.name}. Te ayudo con tu cita de <em>medicina general</em> para hoy (<strong>${label}</strong>).`);mainMenu()}

    function updateClock(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'})}
    setInterval(updateClock,1000);updateClock();

    sendBtn.addEventListener('click',()=>{const v=inputEl.value;inputEl.value='';onUserInput(v)});inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendBtn.click()}});
    hello();
  </script>
</body>
</html>
